/*! grafana - v2.1.0-pre1 - 2015-09-01
 * Copyright (c) 2015 Torkel Ã–degaard; Licensed Apache License */

define(["angular","lodash","jquery","config","kbn","moment","./queryCtrl","./funcEditor","./addGraphiteFunc"],function(a,b,c,d,e,f){"use strict";var g=a.module("grafana.services");g.factory("OpenFalconDatasource",["$q","backendSrv","templateSrv",function(a,d,g){function h(a){this.basicAuth=a.basicAuth,this.url=a.url,this.name=a.name,this.cacheTimeout=a.cacheTimeout,this.withCredentials=a.withCredentials,this.render_method=a.render_method||"POST"}return h.prototype.query=function(b){try{var c={from:this.translateTime(b.range.from,"round-down"),until:this.translateTime(b.range.to,"round-up"),targets:b.targets,format:b.format,cacheTimeout:b.cacheTimeout||this.cacheTimeout,maxDataPoints:b.maxDataPoints},d=this.buildOpenFalconParams(c,b.scopedVars);if("png"===b.format)return a.when(this.url+"/render?"+d.join("&"));var e={method:this.render_method,url:"/render"};return"GET"===e.method?e.url=e.url+"?"+d.join("&"):(e.data=d.join("&"),e.headers={"Content-Type":"application/x-www-form-urlencoded"}),this.doOpenFalconRequest(e).then(this.convertDataPointsToMs)}catch(f){return a.reject(f)}},h.prototype.convertDataPointsToMs=function(a){var c={};if(!a.data.length)return a;if("chartType"in a.data[0])return c.datapoints=a.data,a.data=[c],a;var d=[],e=[],f=0,g=0,h=[],i="",j="";if(b.forEach(a.data,function(a){"Values"in a&&(h=a.Values,i=a.counter,j=a.endpoint,e=[],b.forEach(h,function(a){f=a.timestamp,g=a.value,e.push([g,f])}),c={},c.datapoints=e,c.target=j+"."+i,d.push(c))}),a.data=d,!a||!a.data)return[];for(var k=0;k<a.data.length;k++)for(var l=a.data[k],m=0;m<l.datapoints.length;m++)l.datapoints[m][1]*=1e3;return a},h.prototype.annotationQuery=function(a,b){if(a.target){var c=g.replace(a.target),d={range:b,targets:[{target:c}],format:"json",maxDataPoints:100};return this.query(d).then(function(b){for(var c=[],d=0;d<b.data.length;d++)for(var e=b.data[d],f=0;f<e.datapoints.length;f++){var g=e.datapoints[f];g[0]&&c.push({annotation:a,time:g[1],title:e.target})}return c})}var e=g.replace(a.tags);return this.events({range:b,tags:e}).then(function(b){for(var c=[],d=0;d<b.data.length;d++){var e=b.data[d];c.push({annotation:a,time:1e3*e.when,title:e.what,tags:e.tags,text:e.data})}return c})},h.prototype.events=function(b){try{var c="";return b.tags&&(c="&tags="+b.tags),this.doOpenFalconRequest({method:"GET",url:"/events/get_data?from="+this.translateTime(b.range.from)+"&until="+this.translateTime(b.range.to)+c})}catch(d){return a.reject(d)}},h.prototype.translateTime=function(a,c){if(b.isString(a)){if("now"===a)return"now";if(a.indexOf("now")>=0)return a=a.substring(3),a=a.replace("m","min"),a=a.replace("M","mon");a=e.parseDate(a)}return a=f.utc(a),"round-up"===c?a.get("s")&&a.add(1,"m"):"round-down"===c&&a.get("s")&&a.subtract(1,"m"),a.unix()},h.prototype.metricFindQuery=function(c){var d;try{d=encodeURIComponent(g.replace(c))}catch(e){return a.reject(e)}return this.doOpenFalconRequest({method:"GET",url:"/metrics/find/?query="+d}).then(function(a){return b.map(a.data,function(a){return{text:a.text,expandable:a.expandable?!0:!1}})})},h.prototype.testDatasource=function(){return this.metricFindQuery("*").then(function(){return{status:"success",message:"Data source is working",title:"Success"}})},h.prototype.listDashboards=function(a){return this.doOpenFalconRequest({method:"GET",url:"/dashboard/find/",params:{query:a||""}}).then(function(a){return a.data.dashboards})},h.prototype.loadDashboard=function(a){return this.doOpenFalconRequest({method:"GET",url:"/dashboard/load/"+encodeURIComponent(a)})},h.prototype.doOpenFalconRequest=function(a){return(this.basicAuth||this.withCredentials)&&(a.withCredentials=!0),this.basicAuth&&(a.headers=a.headers||{},a.headers.Authorization=this.basicAuth),a.url=this.url+a.url,a.inspect={type:"graphite"},d.datasourceRequest(a)},h.prototype._seriesRefLetters=["#A","#B","#C","#D","#E","#F","#G","#H","#I","#J","#K","#L","#M","#N","#O","#P","#Q","#R","#S","#T","#U","#V","#W","#X","#Y","#Z"],h.prototype.buildOpenFalconParams=function(a,d){function e(a){return a.replace("m","min").replace("M","mon")}function f(a){return m[a]}var h,i,j,k=["from","until","rawData","format","maxDataPoints","cacheTimeout"],l=[],m={},n=/(\#[A-Z])/g,o=/'(\d+)m'/gi;for("png"!==a.format&&(a.format="json"),j=0;j<a.targets.length;j++)h=a.targets[j],h.target&&(i=g.replace(h.target,d),i=i.replace(o,e),m[this._seriesRefLetters[j]]=i);for(j=0;j<a.targets.length;j++)h=a.targets[j],h.target&&!h.hide&&(i=m[this._seriesRefLetters[j]],i=i.replace(n,f),m[this._seriesRefLetters[j]]=i,l.push("target="+encodeURIComponent(i)));return b.each(a,function(a,b){-1!==c.inArray(b,k)&&a&&l.push(b+"="+encodeURIComponent(a))}),l},h}])});